<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AulaPudu — Aprende sin fronteras</title>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- INICIO: tu CSS EXACTO (no modificado) --- */
:root{
  --bg-top: #fff7ef;
  --bg-bottom: #bfe3d7;
  --text-dark: #134433;
  --muted: #315a52;
  --yellow: #f5cf66;
  --green: #88c1b2;
  --radius: 18px;
  --card-padding: 22px 28px;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text-dark);
  background:linear-gradient(180deg,var(--bg-top) 20%, rgba(191,227,215,0.9) 60%, var(--bg-bottom) 100%);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Header */
.site-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:36px 72px 0 72px;
}
.brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand h1{
  margin:0;
  font-weight:700;
  color:var(--text-dark);
  font-size:28px;
}
.logo{
  width:56px;
  height:auto; /* mantiene proporción */
}

/* Nav */
.nav{font-size:16px;color:var(--muted)}
.nav a{color:var(--muted); text-decoration:none; padding:0 8px}
.sep{color:var(--muted); opacity:0.6}

/* Hero */
.hero{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:78vh;
  padding:20px 72px 60px 72px;
  overflow:hidden;
}
.pudu-big {
  position: fixed;     /* en vez de absolute */
  left: 0;
  bottom: 0;
  height: 100vh;       /* ocupa toda la altura visible */
  width: auto;
  object-fit: contain;
  pointer-events: none;
  user-select: none;
  z-index: 1;
}



/* Content block */
.hero-content{
  width:54%;
  max-width:820px;
  text-align:center;
  z-index:2;
}
.eyebrow{
  letter-spacing:6px;
  font-weight:700;
  margin:0;
  color:var(--muted);
  font-size:18px;
}
.headline{
  font-size:72px;
  margin:8px 0 18px 0;
  line-height:0.95;
  color:var(--text-dark);
}
.subhead{
  margin:0 auto 34px auto;
  max-width:680px;
  line-height:1.6;
  font-size:20px;
  color:rgba(19,68,51,0.8);
}

/* CTA */
.cta-list{display:flex;flex-direction:column;gap:22px;align-items:center;margin-top:6px}
.cta{
  display:flex;
  align-items:center;
  gap:18px;
  text-decoration:none;
  min-width:520px;
  padding:var(--card-padding);
  border-radius:26px;
  box-shadow: 0 10px 30px rgba(18,60,50,0.08), inset 0 -6px 0 rgba(0,0,0,0.02);
  font-size:28px;
  font-weight:800;
  color:var(--text-dark);
  transition: all 0.2s; /* Added transition */
}
.cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(18,60,50,0.12), inset 0 -6px 0 rgba(0,0,0,0.02);
}
.cta-icon{
  width:72px;
  height:auto; /* mantiene proporción */
  flex-shrink:0;
  object-fit:contain;
}

/* Specific colors */
.cta-yellow{background:linear-gradient(180deg,var(--yellow), #f0c85a)}
.cta-green{background:linear-gradient(180deg,var(--green), #79b9a6)}
button.red { background-color: #d9534f; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
button.red:hover { background-color: #c9302c; }


/* Responsive */
@media (max-width:980px){
  .hero-content{width:80%}
  .headline{font-size:44px}
  .cta{min-width:360px; font-size:22px}
  .pudu-big{max-width:65%} /* más grande también en pantallas medianas */
}
/* --- INICIO: MEJORAS PARA MÓVIL (max-width: 640px) --- */
@media (max-width:640px){
  /* Layout principal y espaciado */
  .site-header{
    padding: 20px 16px 0 16px; /* Reducir padding horizontal */
  }
  .hero{
    padding: 20px 16px 60px 16px; /* Reducir padding horizontal */
    min-height: 85vh; /* Aumentar el tamaño para aprovechar más el espacio */
  }
  .pudu-big{display:none}
  
  /* Marca y Navegación */
  .brand h1 { font-size: 24px; } /* Reducir el tamaño de la marca */
  .logo { width: 48px; } /* Reducir el tamaño del logo */
  .nav {
    font-size: 14px; /* Reducir un poco el tamaño de la navegación */
    display: flex;
    align-items: center;
  }
  .nav a { padding: 0 6px; } /* Reducir el padding de los enlaces */

  /* Hero Content */
  .hero-content{
    width: 100%; /* Usar todo el ancho */
    max-width: none;
    text-align: center;
  }
  .eyebrow{
    font-size: 14px;
    letter-spacing: 4px;
  }
  .headline{
    font-size: 38px; /* Tamaño de titular más apropiado */
    line-height: 1.1;
    margin: 4px 0 12px 0;
  }
  .subhead{
    font-size: 16px;
    margin-bottom: 24px;
  }

  /* CTA List */
  .cta-list { gap: 16px; } /* Reducir el espacio entre CTAs */
  .cta{
    min-width: 100%; /* Ocupar todo el ancho disponible */
    justify-content: flex-start;
    padding: 18px 24px; /* Ajustar el padding */
    font-size: 20px; /* Reducir el tamaño de fuente */
  }
  .cta-icon{width:48px;height:auto}

  /* App Shell (Contenido Interno) */
  .app-shell {
    padding: 0 16px 60px 16px; /* Reducir el padding horizontal */
  }

  /* Formularios (Login/Join) */
  .auth-form, .spectator-input-card {
    padding: 30px 20px; /* Reducir el padding interno */
  }
  .auth-form h2, .spectator-input-card h2 { font-size: 24px; }

  /* Dashboard Layout */
  .presenter-dashboard {
    flex-direction: column; /* Apilar sidebar y main-content */
    gap: 20px;
    margin-top: 20px !important;
  }

  /* Sidebar */
  .sidebar {
    width: 100%; /* Ocupar todo el ancho */
    padding: 10px 0;
    order: -1; /* Mover la barra lateral hacia arriba (opcional: mejor para UX móvil) */
  }
  .sidebar h3 {
    margin: 10px 15px;
    border-bottom: none;
    padding-bottom: 0;
    font-size: 16px;
    text-align: center;
    display: none; /* Ocultar el título 'Menú del Presentador' para ahorrar espacio */
  }
  .sidebar ul {
    display: flex; /* Mostrar como una barra horizontal deslizante si es necesario */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0 5px; /* Pequeño padding para los bordes */
  }
  .sidebar li { flex-shrink: 0; }
  .sidebar li a {
    padding: 8px 15px; /* Más compacto */
    font-size: 14px;
    border-left: none; /* Quitar borde izquierdo en móvil */
    border-radius: 10px; /* Borde suave */
    margin: 0 5px;
    text-align: center;
  }
  .sidebar li a.active {
    border-left: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .sidebar li a span { display: none; } /* Ocultar el texto para mostrar solo el ícono (opcional) */
  .sidebar li a.active span { display: inline-block; } /* Mostrar solo el icono activo */
  .sidebar li a.active:after { content: attr(data-icon); } /* Si quieres mostrar solo el texto activo, puedes hacer esto */
  .sidebar li a:before { content: attr(data-icon); margin-right: 5px; } /* Mantenemos el ícono, si existe. */
  /* Ajuste rápido para mostrar texto y ícono en móvil */
  .sidebar li a span { display: inline; }


  /* Dashboard Grid */
  .dashboard-grid {
    grid-template-columns: 1fr; /* Una columna en móvil */
  }

  /* Live Session / Questions Builder */
  .presentation-controls {
    flex-direction: column;
    align-items: stretch;
  }
  .live-reactions {
    justify-content: space-around;
    flex-wrap: wrap;
    margin-bottom: 15px;
  }
  .timer-section {
    justify-content: center;
    flex-wrap: wrap;
  }
  .timer-section input { width: 40px !important; }
  .timer-section button { margin-top: 10px; }
  .timer-display { margin-top: 10px; margin-left: 0; }
  
  .question-type-selector {
    flex-wrap: wrap;
  }
  .question-type-selector button { flex-grow: 1; }
  .add-option { width: 100%; }
  
  /* Controles de Presentación */
  #presenter-live-session-content .content-card div[style*="flex"] {
    flex-direction: column;
  }
  #presenter-live-session-content .content-card button {
    width: 100%;
    margin-top: 8px;
  }
  /* Interfaz de Espectador */
  .spectator-interface {
    margin: 20px auto;
    padding: 20px;
  }
  .spectator-interactions button {
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
  
}
/* --- FIN: MEJORAS PARA MÓVIL (max-width: 640px) --- */


/* --- FIN: tu CSS EXACTO (no modificado) --- */


/* --- INICIO: CSS EXTENDIDO Y PROFESIONAL PARA PANTALLAS INTERNAS --- */

.app-shell {
  position: relative;
  z-index: 3;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 72px 80px 72px; /* Espacio para que el footer no quede pegado */
}
.container-panel { margin-top: 24px; }
.hidden { display: none !important; }
.visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px, 1px, 1px, 1px); white-space:nowrap; }

/* Tarjetas y Contenedores */
.card, .spectator-input-card, .content-card {
  background-color: white;
  padding: var(--card-padding);
  border-radius: var(--radius);
  box-shadow: 0 6px 15px rgba(18,60,50,0.08);
  margin-bottom: 20px;
}
.content-card { padding: 25px 30px; }

/* Formularios de Autenticación (Login/Register) */
#presenter-login {
  display: flex;
  justify-content: center;
  padding-top: 50px;
  min-height: 50vh;
}
.auth-form {
  max-width: 450px;
  width: 100%;
  padding: 40px;
  text-align: center;
}
.auth-form h2 {
  font-size: 32px;
  font-weight: 800;
  margin-top: 0;
  margin-bottom: 25px;
}
.auth-form label {
  display: block;
  text-align: left;
  margin-top: 15px;
  margin-bottom: 5px;
  font-weight: 600;
  color: var(--muted);
  font-size: 14px;
}
.auth-form input[type="email"],
.auth-form input[type="password"],
.auth-form input[type="text"] {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  color: var(--text-dark);
}
.auth-form button[type="submit"] {
  width: 100%;
  padding: 15px;
  background-color: var(--green);
  color: white;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 18px;
  box-shadow: 0 4px 10px rgba(136, 193, 178, 0.5);
  transition: background-color 0.2s, transform 0.2s;
}
.auth-form button[type="submit"]:hover {
  background-color: #6dafa0;
  transform: translateY(-1px);
}
.switch-form {
  margin-top: 25px;
  font-size: 14px;
  color: var(--muted);
}
.switch-form a {
  color: var(--text-dark);
  font-weight: 600;
  text-decoration: none;
}


/* Dashboard Layout */
.presenter-dashboard {
  display: flex; /* Mantiene la barra lateral y el contenido uno al lado del otro */
  gap: 30px;
  width: 100%; 
  max-width: 1200px;
}

.sidebar {
  width: 250px;
  flex-shrink: 0;
  background-color: white;
  border-radius: var(--radius);
  padding: 25px 0;
  box-shadow: 0 6px 15px rgba(18,60,50,0.08);
  height: fit-content;
}
.sidebar h3 {
  margin: 0 25px 20px 25px;
  padding-bottom: 10px;
  border-bottom: 1px solid #f0f0f0;
  color: var(--muted);
  font-size: 18px;
}
.sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.sidebar li a {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 25px;
  text-decoration: none;
  color: var(--text-dark);
  font-weight: 600;
  transition: background-color 0.1s, color 0.1s;
  border-left: 4px solid transparent;
}
.sidebar li a:hover {
  background-color: var(--bg-top);
  color: var(--text-dark);
}
.sidebar li a.active {
  background-color: var(--green);
  color: white;
  border-left: 4px solid var(--text-dark);
}
.sidebar li a.active .sidebar-icon {
  filter: brightness(0) invert(1);
}

.main-content {
  flex-grow: 1;
}

/* Dashboard Grid (Overview) */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.dashboard-card {
  background-color: var(--bg-top);
  padding: 25px;
  border-radius: var(--radius);
  box-shadow: inset 0 0 0 2px rgba(136, 193, 178, 0.3);
  transition: transform 0.3s;
}
.dashboard-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(18,60,50,0.1), inset 0 0 0 2px var(--green);
}
.dashboard-card h4 {
  margin-top: 0;
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--muted);
}
.dashboard-card p {
  color: var(--muted);
  line-height: 1.5;
  font-size: 15px;
}
.dashboard-card button {
  background-color: var(--yellow);
  color: var(--text-dark);
  font-weight: 700;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
  margin-top: 10px;
}
.dashboard-card button:hover { opacity: 0.8; }

/* QR Code */
.qr-code-section {
  text-align: center;
  padding: 10px 0;
}
.qr-code-section p {
  font-weight: 600;
  margin-bottom: 10px;
}
.session-id {
  font-size: 20px;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 15px;
  background: var(--bg-top);
  padding: 5px 10px;
  border-radius: 8px;
  display: inline-block;
}


/* Live Session Styles */
.presenter-live-view {
  /* Contenedor principal para organizar controles y vista */
}
.presentation-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
}
.live-reactions {
  display: flex;
  gap: 15px;
}
.reaction-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 20px;
  background: #f0f0f0;
  padding: 8px 12px;
  border-radius: 12px;
  font-weight: 700;
}
.reaction-badge .count {
  font-size: 16px;
  color: var(--muted);
}

.timer-section {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 600;
}
.timer-section input {
  padding: 8px 0;
  border: 1px solid #ddd;
  border-radius: 6px;
  text-align: center;
  font-size: 16px;
}
.timer-section button {
  background-color: var(--green);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
}
.timer-section button:hover { opacity: 0.8; }
.timer-display {
  font-size: 22px;
  font-weight: 800;
  color: #d9534f; /* Rojo para el contador */
  margin-left: 10px;
  padding: 5px 10px;
  border: 2px solid #d9534f;
  border-radius: 8px;
}

/* Question Builder */
.question-builder {
  background-color: white;
  padding: 30px;
  border-radius: var(--radius);
  box-shadow: 0 6px 15px rgba(18,60,50,0.08);
  margin-bottom: 20px;
}
.question-type-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.question-type-selector button {
  background: #f0f0f0;
  color: var(--text-dark);
  border: none;
  padding: 10px 15px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}
.question-type-selector button:hover { background: #e0e0e0; }
.question-type-selector button.active {
  background: var(--text-dark);
  color: white;
}
.question-form input[type="text"]#question-title {
  width: 100%;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid var(--yellow);
  border-radius: 12px;
  font-size: 18px;
}
.options-container {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.option-input {
  display: flex;
  gap: 10px;
  align-items: center;
}
.option-input input {
  flex-grow: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
}
.add-option {
  background: var(--green);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 10px;
  width: 200px;
  font-weight: 600;
}
.option-button {
  background: var(--yellow);
  color: var(--text-dark);
  font-weight: 800;
  padding: 15px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* Spectator Join/Interface */
.spectator-input-card {
  max-width: 450px;
  margin: 50px auto;
  padding: 40px;
  text-align: center;
}
.spectator-input-card h2 {
  font-size: 28px;
  margin-top: 0;
  margin-bottom: 10px;
}
.spectator-input-card p {
  color: var(--muted);
  margin-bottom: 25px;
}
.spectator-input-card label {
  display: block;
  text-align: left;
  margin-top: 15px;
  margin-bottom: 5px;
  font-weight: 600;
  color: var(--muted);
  font-size: 14px;
}
.spectator-input-card input {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  color: var(--text-dark);
}
.spectator-input-card button {
  width: 100%;
  padding: 15px;
  background-color: var(--yellow);
  color: var(--text-dark);
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 18px;
  box-shadow: 0 4px 10px rgba(245, 207, 102, 0.5);
  margin-top: 20px;
  transition: background-color 0.2s, transform 0.2s;
}
.spectator-input-card button:hover {
  background-color: #f0c85a;
  transform: translateY(-1px);
}

.spectator-interface {
  max-width: 900px;
  margin: 30px auto;
  padding: 30px;
  background-color: white;
  border-radius: var(--radius);
  box-shadow: 0 6px 15px rgba(18,60,50,0.08);
  text-align: center;
}
.spectator-presentation-area {
  background-color: #f5f5f5;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
  min-height: 400px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.spectator-presentation-area h3 { color: var(--text-dark); }
.slide-counter {
  font-weight: 600;
  color: var(--muted);
  margin-top: 15px;
}
.spectator-interactions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}
.spectator-interactions button {
  background: var(--bg-top);
  border: 2px solid var(--green);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 28px;
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.1s;
}
.spectator-interactions button:active {
  transform: scale(0.95);
  box-shadow: 0 0 0 5px rgba(136, 193, 178, 0.5);
}
/* --- FIN: CSS EXTENDIDO Y PROFESIONAL PARA PANTALLAS INTERNAS --- */
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <img src="logo.png" alt="AulaPudu logo" class="logo" onerror="this.style.display='none'">
      <h1>AulaPudu</h1>
    </div>
    <nav class="nav">
      <a href="#" onclick="showPage('landing')">Inicio</a>
      <span class="sep">|</span>
      <a href="#" onclick="showPage('presenter-login')">Iniciar</a>
      <span class="sep">|</span>
      <a href="#" onclick="showPage('spectator-join')">Unirse</a>
    </nav>
  </header>

  <main>
    <section id="landing" class="hero" aria-label="Hero principal" style="display:block;">
      <img src="pudu-large.png" alt="Pudu illustration" class="pudu-big" aria-hidden="true" onerror="this.style.display='none'">
      <div class="hero-content" role="region" aria-label="Hero">
        <p class="eyebrow">PLATAFORMA INTERACTIVA PARA APRENDIZAJE</p>
        <h2 class="headline">Aprende sin fronteras</h2>
        <p class="subhead">Conecta, aprende y enseña en un entorno digital interactivo, sin límites.</p>

        <div class="cta-list">
          <a class="cta cta-yellow" href="#" role="button" onclick="showPage('spectator-join')">
            <img src="pudu-icon-grad.png" alt="" class="cta-icon" onerror="this.style.display='none'">
            <span>Entrar como espectador</span>
          </a>

          <a class="cta cta-green" href="#" role="button" onclick="showPage('presenter-login')">
            <img src="pudu-icon.png" alt="" class="cta-icon" onerror="this.style.display='none'">
            <span>Entrar como presentador</span>
          </a>
        </div>
      </div>
    </section>
  </main>

  <div id="app" class="app-shell container-panel" style="display:none;">

    <div id="presenter-login" style="display:none;">
      <div class="card auth-form">
        <h2 id="auth-title">Inicio de Presentador</h2>
        <form id="login-form" onsubmit="event.preventDefault(); authenticateUser();">
          <label for="email">Correo electrónico:</label>
          <input type="email" id="email" name="email" value="presentador@aulapudu.com" required>
          <label for="password">Contraseña:</label>
          <input type="password" id="password" name="password" value="123456" required>
          <button type="submit" style="margin-top:30px;">Iniciar Sesión</button>
          <div class="switch-form">
            ¿No tienes una cuenta? <a href="#" onclick="toggleAuthForm()">Regístrate aquí</a>
          </div>
        </form>
        <form id="register-form" style="display:none;" onsubmit="event.preventDefault(); registerUser();">
          <label for="reg-name">Nombre completo:</label>
          <input type="text" id="reg-name" name="reg-name" required>
          <label for="reg-email">Correo electrónico:</label>
          <input type="email" id="reg-email" name="reg-email" required>
          <label for="reg-password">Contraseña:</label>
          <input type="password" id="reg-password" name="reg-password" required>
          <label for="confirm-password">Confirmar Contraseña:</label>
          <input type="password" id="confirm-password" name="confirm-password" required>
          <button type="submit" style="margin-top:30px;">Registrarse</button>
          <div class="switch-form">
            ¿Ya tienes una cuenta? <a href="#" onclick="toggleAuthForm()">Inicia sesión aquí</a>
          </div>
        </form>
      </div>
    </div>

    <div id="presenter-dashboard" class="presenter-dashboard" style="display:none; margin-top:30px;">
      <div class="sidebar">
        <h3>Menú del Presentador</h3>
        <ul>
          <li><a href="#" data-icon="📊" class="active" onclick="showPresenterContent('overview')"><span class="sidebar-icon">📊</span> Resumen</a></li>
          <li><a href="#" data-icon="📝" onclick="showPresenterContent('presentations')"><span class="sidebar-icon">📝</span> Presentaciones</a></li>
          <li><a href="#" data-icon="🔴" onclick="showPresenterContent('live-session')"><span class="sidebar-icon">🔴</span> Sesión en Vivo</a></li>
          <li><a href="#" data-icon="❓" onclick="showPresenterContent('questions')"><span class="sidebar-icon">❓</span> Preguntas</a></li>
          <li><a href="#" data-icon="👥" onclick="showPresenterContent('spectator-management')"><span class="sidebar-icon">👥</span> Gestión de Espectadores</a></li>
          <li><a href="#" data-icon="📚" onclick="showPresenterContent('course-materials')"><span class="sidebar-icon">📚</span> Materiales</a></li>
          <li><a href="#" data-icon="📈" onclick="showPresenterContent('reports')"><span class="sidebar-icon">📈</span> Informes</a></li>
          <li><a href="#" data-icon="⚙️" onclick="alert('¡Página de configuración próximamente!')"><span class="sidebar-icon">⚙️</span> Configuración</a></li>
          <li><a href="#" data-icon="🚪" onclick="logout()"><span class="sidebar-icon">🚪</span> Cerrar Sesión</a></li>
        </ul>
      </div>

      <div class="main-content">
        <div id="presenter-overview-content" style="display: none;">
          <h2>Resumen del Dashboard</h2>
          <div class="dashboard-grid">
            <div class="dashboard-card fade-in">
              <h4><span class="sidebar-icon">📊</span> Presentación Actual</h4>
              <p id="current-presentation-text">No hay presentación activa. Inicia una nueva o continúa desde tu biblioteca.</p>
              <button onclick="showPresenterContent('presentations')">Gestionar Presentaciones</button>
            </div>

            <div class="dashboard-card fade-in">
              <h4><span class="sidebar-icon">🔴</span> Estado de Sesión en Vivo</h4>
              <div class="qr-code-section">
                <p>Escanear para unirse:</p>
                <img id="qr-code-img" src="" alt="Código QR" style="width:180px;height:180px;border-radius:12px; display:none;" onerror="this.style.display='none'">
                <div class="session-id" id="session-id-display" style="margin-top:10px;">--</div>
                <button onclick="generateNewSession()">Generar Nuevo Código QR</button>
              </div>
            </div>

            <div class="dashboard-card fade-in">
              <h4><span class="sidebar-icon">📈</span> Actividad Reciente</h4>
              <p>5 nuevos espectadores se unieron a la presentación 'Introducción a la IA'.</p>
              <p>Resultados del quiz exportados para 'Revisión del Módulo 1'.</p>
              <button onclick="showPresenterContent('reports')">Ver Toda la Actividad</button>
            </div>
          </div>
        </div>

        <div id="presenter-presentations-content" style="display:none;">
          <h2>Mis Presentaciones</h2>
          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📤</span> Subir Nueva Presentación</h3>
            <p>Formatos soportados: PDF, PowerPoint (PPT/PPTX)</p>
            <input type="file" id="presentation-upload" accept=".pdf,.ppt,.pptx" style="margin-bottom: 15px;">
            <button onclick="uploadPresentation()" id="upload-presentation-btn">Subir Presentación</button>
            <div id="upload-presentation-status" style="margin-top: 10px;"></div>
          </div>

          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📁</span> Presentaciones Disponibles</h3>
            <ul id="presentations-list" style="list-style:none;padding:0;margin:0;">
              </ul>
          </div>
        </div>

        <div id="presenter-live-session-content" style="display:none;">
          <h2>Control de Sesión en Vivo</h2>
          <div class="presenter-live-view">
            <div class="presentation-controls">
              <div class="live-reactions">
                <div class="reaction-badge">
                  <span>❤️</span>
                  <span class="count" id="count-love">0</span>
                </div>
                <div class="reaction-badge">
                  <span>👏</span>
                  <span class="count" id="count-clap">0</span>
                </div>
                <div class="reaction-badge">
                  <span>❓</span>
                  <span class="count" id="count-question">0</span>
                </div>
                <div class="reaction-badge">
                  <span>👍</span>
                  <span class="count" id="count-thumbsup">0</span>
                </div>
                <div class="reaction-badge">
                  <span>👎</span>
                  <span class="count" id="count-thumbsdown">0</span>
                </div>
              </div>

              <div class="timer-section">
                <input type="number" id="timer-hours" min="0" max="99" value="0" placeholder="HH" style="width: 50px; text-align: center;">
                <span>:</span>
                <input type="number" id="timer-minutes" min="0" max="59" value="0" placeholder="MM" style="width: 50px; text-align: center;">
                <span>:</span>
                <input type="number" id="timer-seconds" min="0" max="59" value="0" placeholder="SS" style="width: 50px; text-align: center;">
                <button onclick="startTimerWithInput()">Iniciar Timer</button>
                <button onclick="resetTimerAndReactions()">Reiniciar</button>
                <span class="timer-display" id="timer-display">00:00:00</span>
              </div>
            </div>

            <div class="content-card fade-in">
              <h3><span class="sidebar-icon">🔴</span> Presentando Actualmente: <span id="current-presentation-title">--</span></h3>
              <p>Diapositiva Actual: <span id="current-slide">1</span>/<span id="total-slides">1</span></p>

              <div style="display:flex;gap:10px;margin-top:10px;">
                <button onclick="prevSlide()">Diapositiva Anterior</button>
                <button onclick="nextSlide()">Siguiente Diapositiva</button>
                <button style="background-color: var(--yellow); color: var(--text-dark);" onclick="endSession()">Finalizar Sesión</button>
              </div>

              <div id="pdf-viewer-container" style="width:100%; height:500px; margin-top:20px; border:1px solid #ddd; border-radius:8px; overflow:auto;">
                <canvas id="pdf-canvas" style="display:block;margin:0 auto;"></canvas>
                <div id="current-slide-content" style="padding:20px; text-align:center;">
                  <h3>Diapositiva 1</h3>
                  <p>Carga una presentación PDF para previsualizar aquí.</p>
                </div>
              </div>
            </div>

            <div class="dashboard-grid" style="margin-top:16px;">
              <div class="dashboard-card fade-in">
                <h4><span class="sidebar-icon">📊</span> Encuestas y Quizzes</h4>
                <p>Crea encuestas interactivas y quizzes para tu audiencia.</p>
                <button onclick="showPresenterContent('questions')">Crear Nueva Pregunta</button>
              </div>

              <div class="dashboard-card fade-in">
                <h4><span class="sidebar-icon">👥</span> Espectadores Conectados</h4>
                <p id="connected-spectators">0 espectadores activos</p>
                <button onclick="showPresenterContent('spectator-management')">Gestionar Espectadores</button>
              </div>
            </div>
          </div>
        </div>

        <div id="presenter-questions-content" style="display:none;">
          <h2>Sistema de Preguntas y Formularios</h2>

          <div class="question-builder fade-in">
            <h3><span class="sidebar-icon">❓</span> Crear Nueva Pregunta</h3>

            <div class="question-type-selector">
              <button class="active" onclick="setQuestionType('multiple-choice', event)">Opción Múltiple</button>
              <button onclick="setQuestionType('true-false', event)">Verdadero/Falso</button>
              <button onclick="setQuestionType('open-ended', event)">Respuesta Abierta</button>
            </div>

            <div class="question-form">
              <input type="text" id="question-title" placeholder="Escribe tu pregunta aquí">
              <div id="options-container" class="options-container">
                <div class="option-input">
                  <input type="text" placeholder="Opción 1">
                  <button class="red" onclick="removeOption(this)">✕</button>
                </div>
                <div class="option-input">
                  <input type="text" placeholder="Opción 2">
                  <button class="red" onclick="removeOption(this)">✕</button>
                </div>
              </div>
              <button class="add-option" onclick="addOption()">+ Añadir Opción</button>
              <button class="option-button" onclick="saveQuestion()" style="width:100%; margin-top:15px;">
                <span class="sidebar-icon">💾</span> Guardar Pregunta
              </button>
            </div>
          </div>

          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📋</span> Preguntas Guardadas</h3>
            <ul id="saved-questions" style="list-style:none;padding:0;margin:0;">
              </ul>
          </div>
        </div>

        <div id="presenter-spectator-management-content" style="display:none;">
          <h2>Gestión de Espectadores</h2>
          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">👥</span> Espectadores Conectados (<span id="active-spectators">0</span> Activos)</h3>
            <ul id="spectators-list" style="list-style:none;padding:0;margin:0;">
              </ul>
            <button style="margin-top:15px; opacity:0.5; cursor:not-allowed;" disabled>Agrupar Espectadores Aleatoriamente</button>
          </div>

          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📎</span> Archivos de Espectadores</h3>
            <p id="spectator-files-status">No hay nuevos archivos subidos por espectadores.</p>
            <button onclick="loadSpectatorFiles()">Ver Todos los Archivos</button>
            <div id="spectator-files-list" style="margin-top:15px;"></div>
          </div>
        </div>

        <div id="presenter-course-materials-content" style="display:none;">
          <h2>Materiales del Curso</h2>
          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📤</span> Subir Nuevo Material</h3>
            <p>Formatos soportados: PDF, DOCX, PPTX, imágenes</p>
            <input type="file" id="material-upload" style="margin-bottom:15px;">
            <button onclick="uploadMaterial()" id="upload-material-btn">Subir Material</button>
            <div id="upload-material-status" style="margin-top:10px;"></div>
          </div>

          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📚</span> Material de Estudio Disponible</h3>
            <ul id="materials-list" style="list-style:none;padding:0;margin:0;">
              </ul>
          </div>
        </div>

        <div id="presenter-reports-content" style="display:none;">
          <h2>Informes y Analíticas</h2>
          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">📝</span> Resultados de Quiz: 'Intro a IA'</h3>
            <p>Resumen de respuestas y datos de participantes.</p>
            <button onclick="generateHTMLReport()">Generar Reporte HTML</button>
          </div>

          <div class="content-card fade-in">
            <h3><span class="sidebar-icon">✅</span> Reporte de Asistencia: Última Sesión</h3>
            <p>Registros detallados de asistencia incluyendo tiempos de conexión.</p>
            <button onclick="viewAttendance()">Ver Asistencia</button>
          </div>

          <div class="content-card fade-in" id="attendance-report" style="display:none;">
            <h3><span class="sidebar-icon">👥</span> Lista de Asistencia</h3>
            <div id="attendance-list"></div>
          </div>

          <div id="html-report-container" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div id="spectator-join" style="display:none;">
      <div class="spectator-input-card card">
        <h2>Unirse a una Presentación</h2>
        <p>Escanee el código QR o ingrese el ID de sesión para unirse.</p>
        <label for="session-id-input">ID de Sesión:</label>
        <input type="text" id="session-id-input" placeholder="ej. AULAPUDU-12345" required>
        <label for="spectator-name">Tu Nombre:</label>
        <input type="text" id="spectator-name" placeholder="Ingresa tu nombre" required>
        <button onclick="event.preventDefault(); joinSession()">Unirse a la Sesión</button>
      </div>
    </div>

    <div id="spectator-interface" style="display:none;">
      <div class="spectator-interface">
        <h2>Presentación en Vivo: <span id="spectator-presentation-title">Introducción a la Ciencia de Datos</span></h2>
        <div class="spectator-presentation-area">
          <div class="slide-container">
            <div id="spectator-current-slide-content">
              <h3>Esperando al Presentador</h3>
              <p>La presentación comenzará pronto o ya está en curso...</p>
            </div>
            <div class="slide-nav">
              <div class="slide-counter">Diapositiva <span id="spectator-slide-number">--</span> de <span id="spectator-total-slides">--</span></div>
            </div>
          </div>
        </div>

        <div class="spectator-interactions">
          <button title="¡Me encanta!" onclick="sendReaction('love')">❤️</button>
          <button title="¡Aplaudir!" onclick="sendReaction('clap')">👏</button>
          <button title="Pregunta" onclick="sendReaction('question')">❓</button>
          <button title="Pulgar Arriba" onclick="sendReaction('thumbsup')">👍</button>
          <button title="Pulgar Abajo" onclick="sendReaction('thumbsdown')">👎</button>
        </div>

        <div class="spectator-input-card card" style="margin-top:30px;">
          <h3>Contenido Interactivo</h3>
          <p>Participa en encuestas, responde preguntas o sube archivos.</p>
          <button onclick="answerQuestion()">Responder Pregunta</button>
          <button style="margin-top:10px;" onclick="uploadFileAsSpectator()">Subir Archivo al Presentador</button>
          <button style="margin-top:10px;">Descargar Material de Estudio</button>
        </div>
      </div>
    </div>

  </div> <footer class="site-footer" aria-hidden="true" style="padding:40px 80px 80px 80px;"></footer>

  <script>
    /************************************************************************
     * CONFIG
     ************************************************************************/
    const SUPABASE_URL = "https://kcmxanjadpriphneygtx.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjbXhhbmphZHByaXBobmV5Z3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTU0ODMsImV4cCI6MjA3Mjg3MTQ4M30.J9tJn1pjdUHlFfTPpqWslWLs16CTs22IZiEgCjOMbGY"; 
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /************************************************************************
     * ESTADO LOCAL Y SIMULACIÓN DE BD
     ************************************************************************/
    let currentSessionCode = null; 
    let currentUser = null;
    let currentPresentation = null;
    let currentSlide = 1; 
    let totalSlides = 10; 
    let questionType = 'multiple-choice';
    let reactionCounts = { love:0, clap:0, question:0, thumbsup:0, thumbsdown:0 };
    let timerInterval = null, timerSeconds = 0;
    let pdfDoc = null;
    let currentFileUrl = null;
    let fileType = null;
    let rt = { chan: null, sessionId: null, presenceKey: null, liveSpectators: {} };
    let isPresenter = false;
    
    // Almacenamiento local para archivos subidos por el presentador (simulación de Supabase Storage)
    let uploadedFiles = {
      presentations: [],
      materials: []
    };
    let savedQuestions = [];

    /************************************************************************
     * NAVEGACIÓN VISTAS
     ************************************************************************/
    function showPage(pageId){
      const ids = ['presenter-login','presenter-dashboard','spectator-join','spectator-interface'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      const landingEl = document.getElementById('landing');
      const appShellEl = document.getElementById('app');

      if (pageId === 'landing'){
        if (landingEl) landingEl.style.display = 'flex';
        if (appShellEl) appShellEl.style.display = 'none';
        isPresenter = false;
        cleanupRealtime();
      } else {
        if (landingEl) landingEl.style.display = 'none';
        if (appShellEl) appShellEl.style.display = 'block';

        if (pageId === 'presenter-dashboard' && !currentUser) {
          pageId = 'presenter-login';
        }

        const el = document.getElementById(pageId);
        if (el) el.style.display = 'block';
        if (pageId === 'presenter-dashboard'){
            isPresenter = true;
            // Cargar listas dinámicas al entrar al dashboard
            loadSavedQuestions();
            loadPresentationsListUI();
            loadMaterialsListUI();
            // Mostrar la página de resumen por defecto
            showPresenterContent('overview');
            if(currentSessionCode) generateQrCode(currentSessionCode);
        } else {
            isPresenter = false;
        }
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleAuthForm(){
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const authTitle = document.getElementById('auth-title');
      const isLogin = loginForm.style.display !== 'none';
      loginForm.style.display = isLogin ? 'none' : 'block';
      registerForm.style.display = isLogin ? 'block' : 'none';
      authTitle.innerText = isLogin ? 'Registro de Presentador' : 'Inicio de Presentador';
    }

    function showPresenterContent(contentId){
      const mainContentDiv = document.querySelector('#presenter-dashboard .main-content');
      if (!mainContentDiv) return;
      
      // Ocultar todos los bloques de contenido (que son hijos directos de main-content)
      mainContentDiv.querySelectorAll(':scope > div').forEach(d => {
        d.style.display = 'none';
      });

      // Mostrar el bloque de contenido solicitado
      const target = document.getElementById('presenter-' + contentId + '-content');
      if (target) {
        target.style.display = 'block';
      } else {
        console.error(`Contenido ID: presenter-${contentId}-content no encontrado.`);
        return;
      }

      // Ajustar la clase activa de la barra lateral
      document.querySelectorAll('.sidebar ul li a').forEach(a => a.classList.remove('active'));
      const match = document.querySelector(`.sidebar ul li a[onclick*="${contentId}"]`);
      if (match) match.classList.add('active');

      // Lógica específica al cargar la "página"
      if (contentId === 'live-session') {
        document.getElementById('total-slides').textContent = totalSlides;
        document.getElementById('current-slide').textContent = currentSlide;
        document.getElementById('current-presentation-title').textContent = currentPresentation || '--';
        // Simular o mostrar contenido de la diapositiva
        if (!pdfDoc) {
             document.getElementById('current-slide-content').style.display = 'block';
             document.getElementById('pdf-canvas').style.display = 'none';
        } else {
            // Si hay un PDF cargado, se renderiza la página
            renderPDFPage(currentSlide);
        }
      }
      if (contentId === 'spectator-management') updateSpectatorList(); 
      if (contentId === 'reports') updateAttendanceReport();
      if (contentId === 'presentations') loadPresentationsListUI();
      if (contentId === 'course-materials') loadMaterialsListUI();
      if (contentId === 'questions') loadSavedQuestions();
    }

    /************************************************************************
     * AUTH (SIMULACIÓN FORZADA)
     ************************************************************************/
    async function authenticateUser(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      // SIMULACIÓN FORZADA DE ÉXITO (Independiente de Supabase)
      if (true) { 
          currentUser = { id: 'demo-presenter-123', email: email, user_metadata: { name: 'Presentador Demo' } };
          showPage('presenter-dashboard');
          return;
      }
    }

    async function registerUser(){
      alert('Funcionalidad de registro (demo).');
      toggleAuthForm();
    }

    async function logout(){
      currentUser = null;
      await cleanupRealtime();
      showPage('landing');
    }

    /************************************************************************
     * SESSIONS (QR Y CÓDIGO)
     ************************************************************************/
    function generateQrCode(code) {
        const qrImg = document.getElementById('qr-code-img');
        const joinUrl = `${window.location.origin}${window.location.pathname}?session=${code}`;
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(joinUrl)}`;
        qrImg.style.display = 'block';
    }

    async function generateNewSession(){
      const userId = currentUser ? currentUser.id : 'demo-presenter-123';
      if (!userId) return alert('Primero inicia sesión como presentador.');
      
      const code = 'AULAPUDU-' + Math.floor(10000 + Math.random()*90000);
      currentSessionCode = code;

      try {
        generateQrCode(code);
        document.getElementById('session-id-display').textContent = code;

        await initRealtimeForSession(currentSessionCode, { asPresenter: true });
        
        alert(`Nueva sesión creada: ${currentSessionCode}. ¡El panel de control en tiempo real está activo!`);

      } catch (err) {
        console.error('generateNewSession', err);
        alert('Error creando sesión: ' + (err?.message || err));
      }
    }

    /************************************************************************
     * ASISTENCIA / GESTIÓN DE ESPECTADORES (RT SIMULADO)
     ************************************************************************/
    async function joinSession(){
      const sessionCode = document.getElementById('session-id-input').value.trim();
      const spectatorName = document.getElementById('spectator-name').value.trim();
      if (!sessionCode || !spectatorName) return alert('Por favor, ingresa el ID de sesión y tu nombre.');
      
      if (sessionCode.substring(0, 9) !== 'AULAPUDU-') return alert('ID de Sesión no válido (Demo).');

      try {
        currentSessionCode = sessionCode;
        await initRealtimeForSession(currentSessionCode, { asSpectator: true, name: spectatorName });
        
        document.getElementById('spectator-presentation-title').textContent = "Sesión en Vivo: " + sessionCode;
        document.getElementById('spectator-total-slides').textContent = totalSlides;
        document.getElementById('spectator-slide-number').textContent = currentSlide;
        
        showPage('spectator-interface');

      } catch(err){
        console.error('joinSession', err);
        alert('Error uniendo a la sesión: ' + (err?.message || err));
      }
    }

    // Funciones para manipular la lista de espectadores en la UI
    function addSpectatorToList(name) {
        if (!document.getElementById('spectators-list')) return;
        
        // Simulación: Agregar al estado local de RT
        const key = name.replace(/\s/g, '-').toLowerCase();
        rt.liveSpectators[key] = { name: name };
        
        updateSpectatorList();
    }

    function removeSpectatorFromList(name) {
        if (!document.getElementById('spectators-list')) return;
        
        // Simulación: Eliminar del estado local de RT
        const key = name.replace(/\s/g, '-').toLowerCase();
        delete rt.liveSpectators[key];

        updateSpectatorList();
    }

    async function updateSpectatorList(){
        const list = document.getElementById('spectators-list');
        const countDisplay = document.getElementById('active-spectators');
        if (!list || !countDisplay) return;

        if (!currentSessionCode) {
            list.innerHTML = '<li>Inicia una sesión en vivo para ver los espectadores.</li>';
            countDisplay.textContent = '0';
            return;
        }

        const spectatorsArray = Object.values(rt.liveSpectators);
        
        list.innerHTML = '';
        const activeCount = spectatorsArray.length; 
        countDisplay.textContent = activeCount;

        if (activeCount === 0) {
            list.innerHTML = '<li>No hay espectadores conectados.</li>';
            return;
        }

        spectatorsArray.forEach(s => {
            const item = document.createElement('li');
            item.style.display = 'flex'; item.style.justifyContent = 'space-between'; item.style.alignItems = 'center';
            item.style.padding = '12px 0'; item.style.borderBottom = '1px solid #eee';
            item.innerHTML = `
                <span>👤 ${escapeHtml(s.name)} (Activo)</span>
                <div>
                    <button onclick="alert('Mensaje enviado a ${escapeHtml(s.name)}')">Mensaje</button>
                    <button class="red" onclick="removeSpectatorFromList('${escapeHtml(s.name)}')">✕ Salir</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // Funciones de Asistencia (simulación)
    async function viewAttendance(){
      const rpt = document.getElementById('attendance-report');
      rpt.style.display = (rpt.style.display === 'none' ? 'block' : 'none');
      updateAttendanceReport();
    }
    async function updateAttendanceReport(){
      const list = document.getElementById('attendance-list');
      list.innerHTML = '<p>Funcionalidad de reporte de asistencia (demo).</p>';
    }
    
    /************************************************************************
     * PRESENTACIONES / MATERIALES (LÓGICA DINÁMICA Y PDF.JS)
     ************************************************************************/
    
    // Dibuja los elementos de la lista 'uploadedFiles.presentations' en la UI
    function loadPresentationsListUI() {
      const ul = document.getElementById('presentations-list');
      ul.innerHTML = '';
      if (uploadedFiles.presentations.length === 0) {
        ul.innerHTML = '<li>No hay presentaciones subidas. Utiliza el formulario de arriba.</li>';
        return;
      }
      uploadedFiles.presentations.forEach(p => {
        const li = document.createElement('li');
        li.style.display = 'flex'; li.style.justifyContent = 'space-between'; li.style.padding = '12px 0'; li.style.borderBottom = '1px solid #eee';
        li.innerHTML = `
          <span>${p.name} (${p.type.toUpperCase()})</span>
          <div>
            <button onclick="loadPresentation('${p.name.replace(/'/g,"\\'")}', '${p.type}', '${p.url}')">Cargar</button>
            <button class="red" onclick="deleteFile(event, '${p.name.replace(/'/g,"\\'")}', 'presentations')">Eliminar</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    // Dibuja los elementos de la lista 'uploadedFiles.materials' en la UI
    function loadMaterialsListUI() {
      const ul = document.getElementById('materials-list');
      ul.innerHTML = '';
      if (uploadedFiles.materials.length === 0) {
        ul.innerHTML = '<li>No hay materiales subidos. Utiliza el formulario de arriba.</li>';
        return;
      }
      uploadedFiles.materials.forEach(m => {
        const li = document.createElement('li');
        li.style.display='flex'; li.style.justifyContent='space-between'; li.style.padding='12px 0'; li.style.borderBottom='1px solid #eee';
        li.innerHTML = `<span>${m.name} (${m.type.toUpperCase()})</span><button onclick="viewMaterial('${m.name.replace(/'/g,"\\'")}', '${m.type}', '${m.url}')">Ver</button>`;
        ul.appendChild(li);
      });
    }
    
    // Función central para eliminar archivos de la simulación
    function deleteFile(event, name, type) {
        event.preventDefault();
        if (!confirm(`¿Estás seguro de que deseas eliminar el archivo "${name}"? Esto es una simulación de Supabase Storage.`)) return;
        
        uploadedFiles[type] = uploadedFiles[type].filter(f => f.name !== name);
        
        // Actualizar la UI
        if (type === 'presentations') {
            loadPresentationsListUI();
        } else if (type === 'materials') {
            loadMaterialsListUI();
        }
        alert(`Archivo "${name}" eliminado.`);
    }

    async function uploadPresentation(){
      const input = document.getElementById('presentation-upload');
      const file = input.files[0];
      if (!file) return alert('Selecciona un archivo.');
      
      const uploadBtn = document.getElementById('upload-presentation-btn');
      const uploadStatus = document.getElementById('upload-presentation-status');
      uploadBtn.disabled = true;
      uploadStatus.innerHTML = '<div class="loading-spinner"></div> Subiendo presentación...';
      try {
        const fileExt = file.name.split('.').pop().toLowerCase();
        // Usar FileReader para leer el archivo localmente
        const fileUrl = URL.createObjectURL(file); 

        uploadedFiles.presentations.push({ name: file.name, type: fileExt, url: fileUrl, file });
        
        loadPresentationsListUI(); // Actualizar la UI
        
        input.value = '';
        uploadStatus.innerHTML = 'Presentación subida correctamente';
        setTimeout(()=>{ uploadStatus.innerHTML=''; uploadBtn.disabled=false; }, 1200);
      } catch (err) {
        uploadStatus.innerHTML = 'Error al subir la presentación';
        uploadBtn.disabled = false;
        console.error('uploadPresentation', err);
      }
    }

    async function uploadMaterial(){
      const input = document.getElementById('material-upload');
      const file = input.files[0];
      if (!file) return alert('Selecciona un archivo.');
      
      const uploadBtn = document.getElementById('upload-material-btn');
      const uploadStatus = document.getElementById('upload-material-status');
      uploadBtn.disabled = true;
      uploadStatus.innerHTML = '<div class="loading-spinner"></div> Subiendo material...';
      try {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const fileUrl = URL.createObjectURL(file);

        uploadedFiles.materials.push({ name: file.name, type: fileExt, url: fileUrl });
        
        loadMaterialsListUI(); // Actualizar la UI
        
        input.value = '';
        uploadStatus.innerHTML = 'Material subido correctamente';
        setTimeout(()=>{ uploadStatus.innerHTML=''; uploadBtn.disabled=false; }, 1200);
      } catch(err){
        uploadStatus.innerHTML = 'Error al subir el material';
        uploadBtn.disabled = false;
        console.error('uploadMaterial', err);
      }
    }
    
    // Función para cargar y previsualizar la presentación
    async function loadPresentation(title, type, fileUrl){
      currentPresentation = title;
      currentSlide = 1;
      
      document.getElementById('current-presentation-title').textContent = title;
      document.getElementById('current-presentation-text').textContent = `Presentación activa: ${title}`;
      document.getElementById('spectator-presentation-title').textContent = title;
      currentFileUrl = fileUrl;
      fileType = type;
      totalSlides = 10; // Valor por defecto
      
      const uploadStatus = document.getElementById('upload-presentation-status');
      
      uploadStatus.innerHTML = '<div class="loading-spinner"></div> Cargando presentación para previsualización...';
      
      if (type === 'pdf' && window.pdfjsLib) {
          // Buscamos el objeto de archivo original
          const fileData = uploadedFiles.presentations.find(p => p.name === title);
          
          if (fileData && fileData.file) {
             try {
                // Renderizar PDF.js
                pdfDoc = await pdfjsLib.getDocument(fileUrl).promise;
                totalSlides = pdfDoc.numPages;
                await renderPDFPage(1); // Muestra la primera página
                document.getElementById('pdf-canvas').style.display = 'block';
                document.getElementById('current-slide-content').style.display = 'none';
             } catch (e) {
                console.error("Error al renderizar PDF:", e);
                totalSlides = 1;
                document.getElementById('current-slide-content').innerHTML = `<h3>Error de Carga</h3><p>No se pudo renderizar el PDF. ${e.message}</p>`;
                document.getElementById('pdf-canvas').style.display = 'none';
                document.getElementById('current-slide-content').style.display = 'block';
             }
          } else {
            // Fallback si no se encuentra el objeto File
            totalSlides = 1;
            document.getElementById('current-slide-content').innerHTML = `<h3>Carga Exitosa (Archivo no encontrado)</h3><p>Simulación de presentación de 1 diapositiva.</p>`;
            document.getElementById('pdf-canvas').style.display = 'none';
            document.getElementById('current-slide-content').style.display = 'block';
          }
      } else {
        // Para PPTX y otros tipos, o si PDF.js no está cargado
        totalSlides = 1;
        document.getElementById('current-slide-content').innerHTML = `<h3>Carga Exitosa (Tipo: ${type.toUpperCase()})</h3><p>La previsualización en vivo solo está disponible para archivos PDF.</p>`;
        document.getElementById('pdf-canvas').style.display = 'none';
        document.getElementById('current-slide-content').style.display = 'block';
      }

      // Actualizar contadores
      document.getElementById('total-slides').textContent = totalSlides;
      document.getElementById('current-slide').textContent = currentSlide;
      document.getElementById('spectator-total-slides').textContent = totalSlides;
      document.getElementById('spectator-slide-number').textContent = currentSlide;


      setTimeout(() => {
          uploadStatus.innerHTML = 'Presentación cargada correctamente';
          setTimeout(() => { uploadStatus.innerHTML = ''; showPresenterContent('live-session'); }, 1200);
      }, 800);
    }
    
    // Función central para renderizar la página PDF
    async function renderPDFPage(pageNumber){
      if (!pdfDoc) return;
      const page = await pdfDoc.getPage(pageNumber);
      const canvas = document.getElementById('pdf-canvas');
      const context = canvas.getContext('2d');
      // Escalar para caber en el contenedor
      const containerWidth = document.getElementById('pdf-viewer-container').clientWidth - 40; // Restar padding
      const viewport = page.getViewport({ scale: containerWidth / page.getViewport({ scale: 1 }).width });
      
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      const renderContext = { canvasContext: context, viewport };
      await page.render(renderContext).promise;
      
      currentSlide = pageNumber;
      
      document.getElementById('current-slide').textContent = pageNumber;
      document.getElementById('spectator-slide-number').textContent = pageNumber;
      document.getElementById('current-slide-content').style.display = 'none';
      document.getElementById('pdf-canvas').style.display = 'block';
      
      // La previsualización no necesita reajustar el contenedor, ya se hizo en loadPresentation
    }
    
    function viewMaterial(name, type, url){
      if (type === 'pdf' && url) {
        window.open(url, '_blank');
      } else {
        alert(`Visualizando ${name} (${type.toUpperCase()})`);
      }
    }
    
    function nextSlide(){
      if (currentSlide < totalSlides) {
        currentSlide++;
        if (pdfDoc) renderPDFPage(currentSlide); else updateSlide();
        broadcastSlide();
      }
    }
    function prevSlide(){
      if (currentSlide > 1) {
        currentSlide--;
        if (pdfDoc) renderPDFPage(currentSlide); else updateSlide();
        broadcastSlide();
      }
    }
    function updateSlide(){
        // Esto solo se llama si NO hay PDF cargado (fallback)
        document.getElementById('current-slide').textContent = currentSlide;
        document.getElementById('spectator-slide-number').textContent = currentSlide;
        document.getElementById('current-slide-content').innerHTML = `<h3>Diapositiva ${currentSlide}</h3><p>Contenido de la diapositiva ${currentSlide}</p>`;
    }
    function broadcastSlide(){
      if (rt.chan && rt.chan.send) {
        try { rt.chan.send({ type:'broadcast', event:'slide', payload:{ currentSlide, totalSlides } }); console.log("[RT] Diapositiva enviada:", currentSlide); } catch(e) { console.warn('Error RT slide', e); }
      } else {
          alert('Debes iniciar una sesión con el botón "Generar Nuevo Código QR" para sincronizar la diapositiva.');
      }
    }
    
    /************************************************************************
     * PREGUNTAS (Funcionalidad Completa de Tipos)
     ************************************************************************/
     
    // Configura los campos de opción según el tipo de pregunta
    function setQuestionType(type, event){
      questionType = type;
      document.querySelectorAll('.question-type-selector button').forEach(b => b.classList.remove('active'));
      if (event && event.target) event.target.classList.add('active');
      const c = document.getElementById('options-container');
      
      if (type === 'open-ended'){ 
        c.innerHTML = '<p>Se permite cualquier respuesta de texto corta o párrafo.</p>';
        c.style.display='block'; 
      } else {
        c.style.display='flex';
        // Reiniciar las opciones
        if (type === 'true-false'){
          c.innerHTML = `
            <div class="option-input"><input type="text" value="Verdadero" readonly></div>
            <div class="option-input"><input type="text" value="Falso" readonly></div>`;
        } else {
          // Opción Múltiple
          c.innerHTML = `
            <div class="option-input"><input type="text" placeholder="Opción 1"><button class="red" onclick="removeOption(this)">✕</button></div>
            <div class="option-input"><input type="text" placeholder="Opción 2"><button class="red" onclick="removeOption(this)">✕</button></div>`;
        }
      }
      // Habilitar/deshabilitar botón Añadir Opción
      document.querySelector('.add-option').style.display = (type === 'multiple-choice') ? 'block' : 'none';
    }

    function addOption(){
      const c = document.getElementById('options-container');
      const n = c.children.length + 1;
      const d = document.createElement('div');
      d.className = 'option-input';
      d.innerHTML = `<input type="text" placeholder="Opción ${n}"><button class="red" onclick="removeOption(this)">✕</button>`;
      c.appendChild(d);
    }
    
    function removeOption(btn){
      const c = document.getElementById('options-container');
      if (c.children.length > 2) btn.parentElement.remove();
      else alert('Debe haber al menos dos opciones.');
    }
    
    function saveQuestion(){
      const title = document.getElementById('question-title').value.trim();
      if (!title) return alert('Ingresa una pregunta.');
      
      let options = null;
      if (questionType !== 'open-ended') {
          options = [];
          document.querySelectorAll('#options-container input').forEach(i=>{
            if (i.value.trim()) options.push(i.value.trim());
          });
          if (options.length < 2) return alert('Para este tipo de pregunta, se requieren al menos dos opciones.');
      }
      
      // Simulación de guardar en BD
      const newQuestion = { id: savedQuestions.length + 10, title, qtype: questionType, options };
      savedQuestions.push(newQuestion);
      
      alert('Pregunta guardada correctamente (Demo).');
      document.getElementById('question-title').value = '';
      loadSavedQuestions();
    }

     function loadSavedQuestions(){
      const list = document.getElementById('saved-questions');
      list.innerHTML = '';
      if (savedQuestions.length === 0) {
          // Datos demo de inicialización si no hay nada guardado
          savedQuestions = [
              { id: 1, title: '¿Cuál es la capital de Francia?', qtype: 'multiple-choice', options: ['París', 'Madrid', 'Berlín'] },
              { id: 2, title: 'El pudú es el cérvido más grande del mundo.', qtype: 'true-false', options: ['Verdadero', 'Falso'] },
          ];
      }
      
      if (savedQuestions && savedQuestions.length>0) {
          savedQuestions.forEach(q => {
            const li = document.createElement('li');
            li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='12px 0'; li.style.borderBottom='1px solid #eee';
            li.innerHTML = `
              <div>
                <strong>${escapeHtml(q.title)}</strong><br><small>Tipo: ${getQuestionTypeName(q.qtype)}</small>
              </div>
              <div>
                <button onclick="useQuestionNow(this, ${q.id}, '${q.title.replace(/'/g,"\\'")}', '${q.qtype}', ${q.options ? JSON.stringify(q.options) : 'null'})">Usar ahora</button>
                <button onclick="useQuestionWithTimer(this, ${q.id}, '${q.title.replace(/'/g,"\\'")}', '${q.qtype}', ${q.options ? JSON.stringify(q.options) : 'null'})">Usar con timer</button>
                <button class="red" onclick="deleteQuestion(event,this,${q.id})">Eliminar</button>
              </div>
            `;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = '<li>No hay preguntas guardadas</li>';
        }
    }
    function getQuestionTypeName(type){
      const types = { 'multiple-choice':'Opción múltiple', 'true-false':'Verdadero/Falso', 'open-ended':'Respuesta abierta' };
      return types[type] || type;
    }
    function deleteQuestion(event, buttonElement, questionId){
      event.preventDefault();
      if (!confirm('¿Estás seguro de que deseas eliminar esta pregunta?')) return;
      savedQuestions = savedQuestions.filter(q => q.id !== questionId);
      alert('Pregunta eliminada correctamente (Demo).');
      loadSavedQuestions();
    }
    function useQuestionNow(buttonElement, questionId, title, qtype, options){
      if (!rt.chan) return alert('Debes iniciar una sesión en vivo primero (botón Generar Código QR).');
      alert(`Mostrando pregunta a espectadores: ${title}`);
      if (rt.chan && rt.chan.send) {
        try { rt.chan.send({ type:'broadcast', event:'question', payload:{ questionId, title, qtype, options, mode:'now' } }); console.log("[RT] Pregunta enviada:", title); } catch(e){ console.warn('Error RT question', e); }
      }
    }
    function useQuestionWithTimer(buttonElement, questionId, title, qtype, options){
      if (!rt.chan) return alert('Debes iniciar una sesión en vivo primero (botón Generar Código QR).');
      alert(`Mostrando pregunta con temporizador a espectadores: ${title}`);
      if (rt.chan && rt.chan.send) {
        try { rt.chan.send({ type:'broadcast', event:'question', payload:{ questionId, title, qtype, options, mode:'timer' } }); console.log("[RT] Pregunta con timer enviada:", title); } catch(e){ console.warn('Error RT question', e); }
      }
    }


    /************************************************************************
     * REALTIME (MANTENIDO)
     ************************************************************************/
    async function initRealtimeForSession(sessionCode, opts = {}) {
      await cleanupRealtime();

      rt.sessionId = sessionCode; 
      
      try {
        const topic = `realtime:${sessionCode}`;
        const chan = supa.channel(topic, { 
            config: { broadcast: true, presence: { key: opts.asSpectator ? 'spectator' : 'presenter' } }
        });
        
        rt.chan = chan;

        // Escucha de Reacciones (para Presentador)
        chan.on('broadcast', { event: 'reaction' }, (payload) => {
          if (opts.asPresenter) {
            const k = payload.payload.kind;
            reactionCounts[k] = (reactionCounts[k] || 0) + 1;
            updateReactionCounts();
          }
        });
        
        // Simulación de Presencia (Añadir/Eliminar Espectadores en el estado local)
        chan.on('presence', { event: 'join' }, ({ newPresences }) => {
            newPresences.forEach(p => addSpectatorToList(p.name || 'Espectador Anónimo'));
        });
        chan.on('presence', { event: 'leave' }, ({ leftPresences }) => {
            leftPresences.forEach(p => removeSpectatorFromList(p.name || 'Espectador Anónimo'));
        });
        
        await chan.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                rt.presenceKey = `${Date.now()}-${Math.random().toString(36).slice(2,9)}`;
                const name = opts.name || (opts.asPresenter ? (currentUser?.user_metadata?.name || 'Presentador RT') : 'Espectador Anónimo');
                
                await chan.track({ name: name, id: rt.presenceKey });
                console.log(`[RT] Conexión establecida. Usuario: ${name}`);
                
                // Demo: Al unirse la sesión, agregamos a 2 espectadores simulados
                if (opts.asPresenter) {
                    addSpectatorToList('Andrea Paz');
                    addSpectatorToList('Carlos Ruiz');
                }
            }
        });
        
      } catch(err){
        console.warn('initRealtimeForSession err', err);
        // Fallback: Si Supabase falla, usamos un objeto simulado para que .send() no dé error
        rt.chan = { 
            send: (msg) => { console.warn("RT SIMULADO: Mensaje enviado localmente.", msg); } ,
            untrack: () => Promise.resolve(),
            unsubscribe: () => Promise.resolve(),
        };
        // Simulamos que al menos un espectador se une en modo demo
        rt.liveSpectators['demo-1'] = { name: 'Espectador Demo' };
        alert("Advertencia: No se pudo conectar a Supabase Realtime. El panel funcionará en modo DEMO local (sin Realtime con otros usuarios).");
      }
    }
    
    async function cleanupRealtime(){
        if (rt.chan && rt.chan.unsubscribe) {
             try { rt.chan.untrack(); } catch(e){}
             try { rt.chan.unsubscribe(); } catch(e){}
        }
        rt = { chan:null, sessionId:null, presenceKey:null, liveSpectators: {} };
        document.getElementById('connected-spectators').textContent = '0 espectadores activos';
    }

    /************************************************************************
     * HELPERS
     ************************************************************************/
    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function(s) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
      });
    }

    // Inicialización: Llama a las funciones de carga de datos demo
    (function init(){
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        if (sessionId) {
          document.getElementById('session-id-input').value = sessionId;
          showPage('spectator-join');
        } else {
          showPage('landing');
        }
      } catch(e){ showPage('landing'); }
    })();

  </script>
</body>
</html>
